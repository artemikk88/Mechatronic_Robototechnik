## 1) Задача: доехать до цели и развернуться по ориентации маркера

### Функции

#### `wrap_to_pi(angle_rad)`
- **Назначение:** нормализует угол в диапазон \((-\pi, \pi]\).
- **Почему нужно:** без нормализации робот может поворачивать длинным путем (например, +350° вместо -10°).

#### `azimut_P_control(e, kp=4.0, max_w=18.0)`
- **Назначение:** формирует команду разворота на месте.
- **Параметры:**
  - `e` — угловая ошибка (рад).
  - `kp` — коэффициент P-регулятора угла.
  - `max_w` — ограничение на модуль скорости колеса в режиме поворота.
- **Математика:**
  - `w = clip(kp * e * wheel_L / wheel_R, -max_w, max_w)`
  - команды колес: `[+w, -w]`.

#### `dist_P_control(e, kp=700.0, max_v=220.0)`
- **Назначение:** формирует поступательное движение к цели.
- **Параметры:**
  - `e` — ошибка расстояния до цели (м).
  - `kp` — коэффициент P-регулятора расстояния.
  - `max_v` — ограничение команды по линейному каналу.
- **Математика:**
  - `v = clip(kp * e * wheel_R, -max_v, max_v)`
  - команды колес: `[+v, +v]`.

### Константы и переменные в цикле
- `eps_pos` — допуск достижения позиции цели (м).
- `eps_ang` — допуск по углу при выравнивании по маркеру (рад).
- `DT` — дискрет шага цикла управления (с).
- `MAX_TIME_POS` — максимум времени на этап доезда до цели (с).
- `MAX_TIME_ORIENT` — максимум времени на этап доворота по ориентации (с).
- `target_r` — поза цели в СК робота: `[x_r, y_r, yaw_r_deg]`.
- `err_a` — угол на цель: `atan2(y_r, x_r)`.
- `err_d` — расстояние до цели: `hypot(x_r, y_r)`.
- `err_o` — ошибка по ориентации маркера: `wrap_to_pi(deg2rad(target_r[2]))`.
- `cmd` — итоговая команда колес (сумма углового и линейного каналов).

---

## 2) Задача: провести робота по лабиринту

### Функции

#### `azimut_P_control(e, kp=4.0, max_w=16.0)`
- Поворотный канал, возвращает `[+w, -w]`.
- `e` — угловая ошибка до точки маршрута.
- `kp`, `max_w` — усиление и ограничение поворота.

#### `dist_P_control(e, kp=700.0, max_v=220.0)`
- Линейный канал, возвращает `[+v, +v]`.
- `e` — расстояние до точки.
- `kp`, `max_v` — усиление и ограничение движения вперед.

#### `move_to(pose)`
- **Назначение:** довести робота до одной точки маршрута.
- **Параметр:**
  - `pose` — целевая поза `[x, y, yaw_deg]` в СК мира.
- **Алгоритм:**
  1. Ставит цель `set_target_in_world(pose)`.
  2. Считывает ошибку `err_a` и `err_d` в СК робота.
  3. Если далеко (`err_d > 0.16`) — едет и подруливает.
  4. Если близко — в основном доворачивается.
  5. Завершает по достижению допусков или по timeout.

### Константы и переменные
- `DT` — период шага цикла (с).
- `EPS_POS` — допуск по позиции точки маршрута (м).
- `EPS_ANG` — допуск по углу на точку (рад).
- `WAYPOINT_TIMEOUT` — максимум времени на одну точку маршрута (с).
- `route` — список точек маршрута в СК мира.
- `t0` — время старта прохода к текущей точке.
- `target_r` — цель в СК робота.
- `err_a` — азимутная ошибка до точки.
- `err_d` — дистанционная ошибка до точки.
- `cmd` — команда скоростей колес.

---

## 3) Задача: PI и PID регуляторы

### Функция `run_controller(target_pose, mode='PI', dt=0.05, timeout=10.0)`

#### Параметры функции
- `target_pose` — целевая поза `[x, y, yaw_deg]`.
- `mode` — `'PI'` или `'PID'`.
- `dt` — дискрет интегрирования/дифференцирования (с).
- `timeout` — максимум времени на достижение цели (с).

#### Коэффициенты
- `kp_a`, `ki_a`, `kd_a` — P/I/D коэффициенты для углового канала.
- `kp_d`, `ki_d`, `kd_d` — P/I/D коэффициенты для дистанционного канала.

#### Внутренние переменные
- `i_a`, `i_d` — интегральные состояния (накопление ошибок).
- `prev_a`, `prev_d` — ошибки на предыдущем шаге (для производной).
- `err_a` — текущая угловая ошибка на цель (рад).
- `err_d` — текущая дистанционная ошибка (м).
- `d_a`, `d_d` — производные ошибок.
- `u_w` — управляющее воздействие углового канала.
- `u_v` — управляющее воздействие линейного канала.
- `w_turn` — команда колес для поворота.
- `w_move` — команда колес для прямолинейного движения.
- `cmd` — суммарная команда колес.
- `err_o` — ошибка итоговой ориентации цели при финише.

#### Математика и ограничения
- PI:
  - `u = kp*e + ki*integral(e)`
- PID:
  - `u = kp*e + ki*integral(e) + kd*de/dt`
- Антивиндап:
  - `i_a`, `i_d` ограничиваются `clip`.
- Производная:
  - `d_a`, `d_d` ограничиваются `clip`, чтобы убрать выбросы.
- Около цели:
  - при малом `err_d` линейный канал гасится, чтобы робот не наматывал круги.

---

## Почему такая структура управления
- Для дифференциального робота удобно разделять каналы:
  - **угол** (куда повернуть),
  - **дистанция** (насколько ехать вперед).
- Команда на колеса — это сумма двух компонент:
  - разворот `[+w, -w]`,
  - движение `[+v, +v]`.
- Ограничения (`clip`) защищают от слишком резких и неустойчивых команд.
